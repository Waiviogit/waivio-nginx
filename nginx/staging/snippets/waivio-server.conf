if ($block_bot) {
    return 403;
}

# 1) Challenge page (static) - через backend
location = /challenge {
    proxy_pass       http://captcha_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    add_header       Cache-Control "no-store";
}

# 2) Verify (POST) - to backend
location = /captcha/verify {
    proxy_pass       http://captcha_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect   off;
}

# 3) Internal auth_request to check cookie and bot logic
location = /_captcha_check {
    internal              ;
    proxy_pass            http://captcha_backend;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP $remote_addr;
    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header      X-Is-Bot-IP $is_bot_ip;
    proxy_set_header      Cookie $http_cookie;
    proxy_connect_timeout 1s;
    proxy_read_timeout    1s;
}

# Redirect на challenge при 401
location @captcha_redirect {
    return 302 /challenge?rd=$rd_uri;
}

location /api {
    auth_request       /_captcha_check;
    error_page         401 @captcha_redirect;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_api;
}

location /currencies-api {
    auth_request       /_captcha_check;
    error_page         401 @captcha_redirect;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_currencies;
}

location / {
    auth_request       /_captcha_check;
    error_page         401 @captcha_redirect;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_frontend;
}

location /notifications-api {
    proxy_http_version 1.1;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_notifications;
}

location /objects-bot {
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_objects_bot;
}

location /auth {
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_auth;
    #proxy_redirect off;
}

location /campaigns-api {
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_campaigns;
    #proxy_redirect off;
}

location /campaigns-v2 {
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host2 $http_origin;
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_campaigns_2;
    #proxy_redirect off;
}

location /arbitrage {
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host2 $http_origin;
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_arbitrage;
    #proxy_redirect off;
}

location /assistant {
    proxy_http_version 1.1;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection 'upgrade';
    proxy_set_header   Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_pass         http://waivio_assistant;
}
